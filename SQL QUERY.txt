CREATE DATABASE AVIATION;

USE AVIATION;

CREATE TABLE AIRLINES(
IATA_CODE VARCHAR(25),
AIRLINE VARCHAR(60));

select * from airlines;

LOAD DATA INFILE 'C:\\ProgramData\\MySQL\\MySQL Server 8.0\\Uploads\\airlines.csv'
INTO TABLE AIRLINES
FIELDS TERMINATED BY ','
ENCLOSED BY '"'
LINES TERMINATED BY '\n'
IGNORE 1 ROWS;

SHOW VARIABLES LIKE 'secure_file_priv';

CREATE TABLE AIRPORTS (
IATA_CODE VARCHAR(10),
AIRPORT VARCHAR(100),	
CITY VARCHAR(30),
STATE VARCHAR(10),
COUNTRY	VARCHAR(10),
LATITUDE VARCHAR(20),
LONGITUDE VARCHAR(20));

LOAD DATA INFILE 'C:\\ProgramData\\MySQL\\MySQL Server 8.0\\Uploads\\airports.csv'
INTO TABLE AIRPORTS
FIELDS TERMINATED BY ','
ENCLOSED BY '"'
LINES TERMINATED BY '\n'
IGNORE 1 ROWS;

select * from airports;

desc airports;

CREATE TABLE Flights (
Year_ INT,
MONTH_ INT,
Day_ INT,
DAY_OF_WEEK INT,
AIRLINE VARCHAR(300),
FLIGHT_NUMBER INT,
TAIL_NUMBER VARCHAR(300),
ORIGIN_AIRPORT VARCHAR(300),
DESTINATION_AIRPORT VARCHAR(300),
SCHEDULED_DEPARTURE INT,
DEPARTURE_TIME VARCHAR(300),
DEPARTURE_DELAY VARCHAR(300),
TAXI_OUT VARCHAR(300),
WHEELS_OFF VARCHAR(300),
SCHEDULED_TIME VARCHAR(300),
ELAPSED_TIME VARCHAR(300),
AIR_TIME VARCHAR(300),
DISTANCE INT,
WHEELS_ON VARCHAR(300),
TAXI_IN VARCHAR(300),
SCHEDULED_ARRIVAL INT,
ARRIVAL_TIME VARCHAR(300),
ARRIVAL_DELAY VARCHAR(300),
DIVERTED INT,
CANCELLED INT,
CANCELLATION_REASON varchar(300),
AIR_SYSTEM_DELAY VARCHAR(300),
SECURITY_DELAY VARCHAR(300),
AIRLINE_DELAY VARCHAR(300),
LATE_AIRCRAFT_DELAY VARCHAR(300),
WEATHER_DELAY VARCHAR(300));

load data infile 'C:\\ProgramData\\MySQL\\MySQL Server 8.0\\Uploads\\flights.csv' 
into table flights fields terminated by ','enclosed by '"'lines terminated by '\n'ignore 1 rows;

DROP TABLE FLIGHTS;

SELECT count(*) FROM FLIGHTS;

ALTER TABLE FLIGHTS ADD COLUMN DEPARTURE_STATUS VARCHAR(25), ADD COLUMN ARRIVAL_STATUS VARCHAR(25);
ALTER TABLE FLIGHTS ADD COLUMN WEEKEND_WEEKDAY VARCHAR(30);

UPDATE FLIGHTS
SET DEPARTURE_STATUS = (
CASE 
    WHEN DEPARTURE_DELAY < 0 THEN "EARLY_DEPARTURE"
    WHEN DEPARTURE_DELAY >=15 THEN "DELAY_DEPARTURE"
    WHEN DEPARTURE_DELAY >=0 AND DEPARTURE_DELAY <=14 THEN "ONTIME_DEPARTURE"
    END);

UPDATE FLIGHTS
SET ARRIVAL_STATUS = (
CASE WHEN ARRIVAL_DELAY < 0 THEN "EARLY_ARRIVAL"
	 WHEN ARRIVAL_DELAY >=15 THEN "DELAY_ARRIVAL"
     WHEN ARRIVAL_DELAY >=0 AND ARRIVAL_DELAY <=14 THEN "ONTIME_ARRIVAL"
     END);
     
UPDATE FLIGHTS
SET WEEKEND_WEEKDAY = (
CASE WHEN DAY_OF_WEEK = 6 OR DAY_OF_WEEK = 7 THEN "WEEKEND"
	 WHEN DAY_OF_WEEK NOT IN (6,7) THEN "WEEKDAY"
     END);
     

-- KPI - 1
SELECT AIRLINE,DEPARTURE_STATUS,ARRIVAL_STATUS,
COUNT(CASE WHEN WEEKEND_WEEKDAY = "WEEKEND" THEN AIRLINE END) AS FLIGHTS_ON_WEEKEND,
COUNT(CASE WHEN WEEKEND_WEEKDAY = "WEEKDAY" THEN AIRLINE END) AS FLIGHTS_ON_WEEKDAY 
FROM FLIGHTS GROUP BY AIRLINE,DEPARTURE_STATUS,ARRIVAL_STATUS;
     
-- KPI - 2
SELECT MONTHNAME(STR_TO_DATE(f.month_, '%m'))  AS FIRST_DATE, SUM(f.CANCELLED) AS "CANCELLED_FLIGHTS(JETBLUE_AIRWAYS)"
from FLIGHTS F JOIN AIRLINES A on F.AIRLINE = A.IATA_CODE WHERE A.AIRLINE = "JETBLUE AIRWAYS" AND Day_ = 1 
GROUP BY F.MONTH_;

-- KPI - 3
SELECT AIRLINE, STATE,CITY,DAY_OF_WEEK,
COUNT(CASE WHEN DEPARTURE_DELAY >= 15 THEN AIRLINE END) AS DEPARTURE_DELAY_FLIGHTS,
COUNT(CASE WHEN ARRIVAL_DELAY >= 15 THEN AIRLINE END) AS  ARRIVAL_DELAY_FLIGHTS
FROM FLIGHTS JOIN AIRPORTS ON (AIRPORTS.IATA_CODE = FLIGHTS.ORIGIN_AIRPORT)
GROUP BY AIRLINE,DAY_OF_WEEK,CITY,STATE ORDER BY AIRLINE, STATE,CITY,DAY_OF_WEEK;

-- KPI - 4
SELECT AIRLINE, COUNT(AIRLINE) AS FLIGHTS_ONTIME FROM FLIGHTS 
WHERE (DISTANCE BETWEEN 2500 AND 3000) AND (DEPARTURE_DELAY <= 14 AND ARRIVAL_DELAY <= 14)
GROUP BY AIRLINE;

SHOW INDEX FROM FLIGHTS;

